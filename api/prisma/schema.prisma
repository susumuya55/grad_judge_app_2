// prisma/schema.prisma

// Prisma 7系で prisma.config.ts に接続情報を寄せる運用でも、
// schema.prisma 側に datasource ブロックは必要です（url は書かない）。
datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

enum RoomStatus {
  OPEN
  CLOSED
  EXPIRED
}

model Host {
  id           BigInt   @id @default(autoincrement())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String
  createdAt    DateTime @default(now()) @map("created_at")

  rooms        Room[]

  @@map("hosts")
}

model Room {
  id         BigInt     @id @default(autoincrement())
  publicId   String     @unique @map("public_id")
  hostId     BigInt     @map("host_id")
  name       String
  status     RoomStatus @default(OPEN)
  enterToken Int        @map("enter_token")
  createdAt  DateTime   @default(now()) @map("created_at")
  expiresAt  DateTime   @map("expires_at")

  host         Host              @relation(fields: [hostId], references: [id])
  participants RoomParticipant[]

  @@map("rooms")
}

model RoomParticipant {
  id        BigInt   @id @default(autoincrement())
  roomId    BigInt   @map("room_id")
  studentId String   @map("student_id")
  sended    Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  room      Room          @relation(fields: [roomId], references: [id])
  sessions  RoomSession[]

  @@unique([roomId, studentId])
  @@map("room_participants")
}

model RoomSession {
  id            String   @id
  participantId BigInt   @map("participant_id")
  createdAt     DateTime @default(now()) @map("created_at")

  participant   RoomParticipant @relation(fields: [participantId], references: [id])
  gradJudgeData GradJudgeData[]

  @@map("room_sessions")
}

model GradJudgeData {
  id            BigInt   @id @default(autoincrement())
  roomSessionId String   @map("room_session_id")
  payload       Json
  createdAt     DateTime @default(now()) @map("created_at")

  roomSession   RoomSession @relation(fields: [roomSessionId], references: [id])

  @@map("grad_judge_data")
}
